\section{Eliminating Redundant Type Checks}

\begin{frame}{Eliminating Redundant Type Checks}
  \centering
  
    \includegraphics[width=0.7\textwidth]{inefficient.png}

\end{frame}


\newsavebox\typecaseAbox
\begin{lrbox}{\typecaseAbox}
  \begin{minipage}{8cm}
    \input{typecaseAbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseITEbox
\begin{lrbox}{\typecaseITEbox}
  \begin{minipage}{8cm}
    \input{typecaseITEbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseITEafterbox
\begin{lrbox}{\typecaseITEafterbox}
  \begin{minipage}{8cm}
\input{typecaseITEafterbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseBabox
\begin{lrbox}{\typecaseBabox}
  \begin{minipage}{8cm}
\input{typecaseBabox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseBbox
\begin{lrbox}{\typecaseBbox}
  \begin{minipage}{8cm}
    \input{typecaseBbox}
  \end{minipage}
\end{lrbox}


\newsavebox\typecaseCbox
\begin{lrbox}{\typecaseCbox}
  \begin{minipage}{6cm}
\input{typecaseCbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseChbox
\begin{lrbox}{\typecaseChbox}
  \begin{minipage}{6cm}
\input{typecaseChbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseDbox
\begin{lrbox}{\typecaseDbox}
  \begin{minipage}{8cm}
    \input{typecaseDbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseDhbox
\begin{lrbox}{\typecaseDhbox}
  \begin{minipage}{8cm}
    \input{typecaseDhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseEbox
\begin{lrbox}{\typecaseEbox}
  \begin{minipage}{8cm}
    \input{typecaseEbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseEhbox
\begin{lrbox}{\typecaseEhbox}
  \begin{minipage}{8cm}
    \input{typecaseEhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseFbox
\begin{lrbox}{\typecaseFbox}
  \begin{minipage}{8cm}
    \input{typecaseFbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseFhbox
\begin{lrbox}{\typecaseFhbox}
  \begin{minipage}{8cm}
    \input{typecaseFhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseGabox
\begin{lrbox}{\typecaseGabox}
  \begin{minipage}{8cm}
\input{typecaseGabox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseGbox
\begin{lrbox}{\typecaseGbox}
  \begin{minipage}{8cm}
    \input{typecaseGbox}
  \end{minipage}
\end{lrbox}


\newsavebox\typecaseHbox
\begin{lrbox}{\typecaseHbox}
  \begin{minipage}{8cm}
    \input{typecaseHbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseHhbox
\begin{lrbox}{\typecaseHhbox}
  \begin{minipage}{8cm}
    \input{typecaseHhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseIbox
\begin{lrbox}{\typecaseIbox}
  \begin{minipage}{8cm}
    \input{typecaseIbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseIhbox
\begin{lrbox}{\typecaseIhbox}
  \begin{minipage}{8cm}
    \input{typecaseIhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseJbox
\begin{lrbox}{\typecaseJbox}
  \begin{minipage}{8cm}
    \input{typecaseJbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseJhbox
\begin{lrbox}{\typecaseJhbox}
  \begin{minipage}{8cm}
    \input{typecaseJhbox}
  \end{minipage}
\end{lrbox}

\newsavebox\typecaseKbox
\begin{lrbox}{\typecaseKbox}
  \begin{minipage}{8cm}
    \input{typecaseKbox}
  \end{minipage}
\end{lrbox}


\newsavebox\typecaseKhbox
\begin{lrbox}{\typecaseKhbox}
  \begin{minipage}{8cm}
    \input{typecaseKhbox}
  \end{minipage}
\end{lrbox}



\begin{frame}{Sequential Type Check}
  In general a state in the DFA may have several \Emph{disjoint} transitions, each with its own type label.
  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseAbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \scalebox{0.9}{\input{multiple-transitions}}
    \end{column}    
  \end{columns}

  Some types may be checked multiple times.  We can rewrite the code to \Emph{eliminate redundant checks}.
\end{frame}

\begin{frame}{Decision Tree Structure}
  We programmatically manipulate \code{if ... else ...} using a lazy data structure similar to the following.

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseAbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseITEbox
    \end{column}    
  \end{columns}

  However, for this presentation, we represent the decision tree as \Emph{human readable} Scala code.
\end{frame}



\begin{frame}{Rewrite: 1}
  Introduce \colorbox{pink!30}{\code{if N.typep(x) ... else ...}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseAbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseBabox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 1}
  Introduce \colorbox{pink!30}{\code{if N.typep(x) ... else ...}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseAbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseBbox
    \end{column}    
  \end{columns}
\end{frame}




\begin{frame}{Rewrite: 2}
  In \code{if} part: \colorbox{pink!30}{Supertypes of \code{N} $\to$ \code{STop} }
  
  In \code{else} part: \colorbox{pink!30}{Subtypes of \code{N} $\to$ \code{SEmpty}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseBbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseChbox
    \end{column}    
  \end{columns}
\end{frame}


\begin{frame}{Recognizing Subtypes}
  \centering

  \begin{align*}
    Int&\subseteq Number\\
    Int&\subseteq Int
  \end{align*}

  \scalebox{0.8}{\input{tikz-number.tex}}


  Failure to identify subtypes/supertypes will lead to \Emph{correct} but \Emph{inefficient} code.
\end{frame}




\begin{frame}{Rewrite: 3}
  \begin{columns}
    \begin{column}{0.5\textwidth}
      \colorbox{pink!30}{\code{(STop \& x)} $\to$ \code{x}}\\
      \colorbox{pink!30}{\code{!STop} $\to$ \code{SEmpty}}
      
      \usebox\typecaseCbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \colorbox{pink!30}{\code{(SEmpty \& x)} $\to$ \code{SEmpty}}\\
      \colorbox{pink!30}{\code{!SEmpty} $\to$ \code{STop}}

      \usebox\typecaseDhbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 4}
  \begin{columns}
    \begin{column}{0.5\textwidth}
      \colorbox{pink!30}{\code{SEmpty.typep(x)} $\to$ \code{false}}
      
      \usebox\typecaseDbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \colorbox{pink!30}{\code{STop.typep(x)} $\to$ \code{true}}

      \usebox\typecaseEhbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 5}
  \colorbox{pink!30}{\code{(if true x else y)} $\to$ \code{x}}\\
  \colorbox{pink!30}{\code{(if false x else y)} $\to$ \code{y}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseEbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseFhbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 6}
  Introduce \colorbox{pink!30}{\code{if I.typep(x) ... else ...}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseFbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseGabox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 6}
  Introduce \colorbox{pink!30}{\code{if I.typep(x) ... else ...}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseFbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseGbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 7}
  In \code{if} part: \colorbox{pink!30}{Supertypes of \code{I} $\to$ \code{STop}}\\
  In \code{else} part: \colorbox{pink!30}{Subtypes of \code{I} $\to$ \code{SEmpty}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseGbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseHhbox
    \end{column}    
  \end{columns}
\end{frame}


\begin{frame}{Rewrite: 8}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \colorbox{pink!30}{\code{!STop} $\to$ \code{SEmpty}}
      \usebox\typecaseHbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \colorbox{pink!30}{\code{!SEmpty} $\to$ \code{STop}}
      \usebox\typecaseIhbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 9}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \colorbox{pink!30}{\code{SEmpty.typep(x)} $\to$ \code{false}}
      \usebox\typecaseIbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \colorbox{pink!30}{\code{STop.typep(x)} $\to$ \code{true}}
      \usebox\typecaseJhbox
    \end{column}    
  \end{columns}
\end{frame}

\begin{frame}{Rewrite: 10}
  \colorbox{pink!30}{\code{(if true x else y)} $\to$ \code{x}}\\
  \colorbox{pink!30}{\code{(if false x else y)} $\to$ \code{y}}

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseJbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseKhbox
    \end{column}
  \end{columns}
\end{frame}


\begin{frame}{Rewrite: Summary}
  Code has been rewritten so that each type check occurs no more than once.

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseAbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseKbox
    \end{column}
  \end{columns}

  And it is clear the the code never returns \code{None}.

\end{frame}

\begin{frame}{Decision Tree, Before and After}
  Viewing the \code{if ... else ...} before and after as decision trees.

  \begin{columns}
    \begin{column}{0.5\textwidth}
      \usebox\typecaseITEbox
    \end{column}
    \begin{column}{0.5\textwidth}  %%
      \usebox\typecaseITEafterbox
    \end{column}
  \end{columns}
\end{frame}



